{% extends 'accounts/base.html'%}
{% load static %}
{% load crispy_forms_tags %}
{% block title%}MeetOthers {% endblock %}


{% block content %}
<div class="wrapper">
    <!-- Sidebar -->
    <div id="sidebar" class="text-light collapsed d-flex flex-column">
      <a href="#" class="logo">
        <i class="bi bi-amd"></i><span class="menu-text"><b id='logo_home_dash'>Tech</b>Convene</span>
      </a>
      <button class="mb-3 mt-3" id="toggleSidebar">☰</button>
      <nav class="nav flex-column">
        <a href="{% url 'user_dashboard_view' %}" class="nav-link  text-light">
          <i class="bi bi-house"></i>
          <span class="menu-text">Dashboard</span>
        </a>
        <a href="{% url 'purchased_tickets' %}" class="nav-link text-light">
          <i class="bi bi-ticket"></i>
          <span class="menu-text">Tickets</span>
        </a>
        <a href="{% url 'booked_event' %}" class="nav-link text-light">
          <i class="bi bi-calendar3"></i>
          <span class="menu-text">Booked Events</span>

        <a href="{% url 'chat_view' %}" class="nav-link active text-light">
         <i class="bi bi-people-fill"></i>
          <span class="menu-text">Meet others</span>

        <a href="#" class="nav-link text-light">
          <i class="bi bi-envelope"></i>
          <span class="menu-text">Notifications</span>
        </a>
         <a href="#" class="nav-link text-light">
         <i class="bi bi-chat-dots"></i>
          <span class="menu-text">Chat support</span>
        </a>
        <div>
         <a href="{% url 'profile' %}" class="nav-link text-light">
          {% if user.profile.profile_picture %}
            <img src="{{ user.profile.profile_picture.url }}"  class="rounded-circle" width="30" height="30" alt="no image"/>
            {% else %}
            <img  src="{% static 'accounts/images/avatar.jpg' %}" class="rounded-circle" width="30" height="30"/>
            {% endif %}
          <span class="menu-text">Profile</span>
        </a> 
         <a href="{% url 'logout' %}" class="nav-link text-light">
         <i class="bi bi-box-arrow-left"></i>
          <span class="menu-text">Logout</span>
        </a>
        </div>
        
      </nav>
    </div>

    <!-- Main Content -->
      <div id="content" class="bg-light p-3">
      <div class="content_header_dash container-fluid d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-0">
          <input name="search" id="dashboard-search" type="search" placeholder="Search events, venues, tickets..." aria-label="Search" class="form-control form-control-sm" style="width:320px;">
          <button id="dashboard-search-btn" type="submit" class="btn btn-outline-dark btn-sm">
            <i class="bi bi-search"></i>
          </button>
        </div>
        <div class="d-flex align-items-center gap-3">
          <div class="notification-icon position-relative">
        </div>
        <div class="profile-mini d-flex align-items-center gap-2">
          <img src="{% if user.profile.profile_picture %}{{ user.profile.profile_picture.url }}{% else %}{% static 'accounts/images/avatar.jpg' %}{% endif %}" alt="{{ user.get_full_name }}" class="rounded-circle" width="36" height="36">
          <div class="d-none d-md-block">
            <div style="font-weight:700;font-size:14px;">{{ user.first_name|default:user.username }}</div>
            <div class="text-muted" style="font-size:12px;">{{ user.email }}</div>
          </div>
        </div>
      </div>
    </div>
      
      <h4 class="welcome-greeting container-fluid" >Chat View</h4>
        <style>
          /* Modern, minimal chat styles */
          .page-container {
            display: flex;
            justify-content: center;
            width: 100%;
            padding: 2rem 0;
            box-sizing: border-box;
          }
          .chat-card {
            width: 100%;
            max-width: 920px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(16,24,40,0.06);
            overflow: hidden;
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: calc(100vh - 200px);
          }
          .chat-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 0.75rem;
          }
          .chat-header .title {
            font-weight: 700;
            font-size: 1.05rem;
            color: #0f172a;
          }
          .chat-body {
            padding: 1rem;
            background: linear-gradient(180deg,#fbfdff 0%, #f8fafc 100%);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
          }
          .msg {
            max-width: 76%;
            display: inline-flex;
            flex-direction: column;
            gap: 0.35rem;
          }
          .msg .bubble {
            padding: 0.6rem 0.9rem;
            border-radius: 12px;
            font-size: 0.98rem;
            line-height: 1.3;
            box-shadow: 0 2px 6px rgba(2,6,23,0.04);
            word-break: break-word;
          }
          .msg.sent {
            align-self: flex-end;
            text-align: right;
          }
          .msg.sent .bubble {
            background: linear-gradient(180deg,#2563eb 0%, #1d4ed8 100%);
            color: #fff;
            border-bottom-right-radius: 4px;
          }
          .msg.received {
            align-self: flex-start;
          }
          .msg.received .bubble {
            background: #f1f5f9;
            color: #0f172a;
            border-bottom-left-radius: 4px;
          }
          .msg .meta {
            font-size: 0.78rem;
            color: #64748b;
          }
          .chat-composer {
            padding: 0.85rem;
            border-top: 1px solid #f1f5f9;
            background: #ffffff;
            display: flex;
            gap: 0.5rem;
            align-items: center;
          }
          .chat-composer textarea {
            flex: 1;
            min-height: 48px;
            max-height: 140px;
            resize: vertical;
            padding: 0.65rem 0.85rem;
            border-radius: 10px;
            border: 1px solid #e6edf3;
            background: #fbfdff;
            font-size: 0.98rem;
            outline: none;
          }
          .chat-composer button.send-btn {
            background: #0f172a;
            color: #fff;
            border: none;
            padding: 0.6rem 0.9rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
          }
          .chat-composer button.send-btn:disabled {
            opacity: 0.5;
            cursor: default;
          }
          @media (max-width: 720px) {
            .chat-card { height: calc(100vh - 120px); }
            .chat-body { padding: 0.75rem; }
          }
        </style>

       <div class="page-container">
        <div class="chat-card" role="region" aria-label="Chat room">
          <div class="chat-header">
            <div class="title">Chat • <span class="text-muted">{{ room_event }}</span></div>
          </div>

          <div class="chat-body" id="chats-container">
            {% for get_message in get_messages %}
              {% if get_message.sender.username.lower == username.lower %}
                <div class="msg sent">
                  <div class="bubble">{{ get_message.message }}</div>
                  <div class="meta">Me</div>
                </div>
              {% else %}
                <div class="msg received">
                  <div class="bubble">{{ get_message.message }}</div>
                  <div class="meta">{{ get_message.sender.username }}</div>
                </div>
              {% endif %}
            {% endfor %}
          </div>

          <div class="chat-composer">
            <form id="msg-form" autocomplete="off">
              {% csrf_token %}
              <textarea id="message" name="message" placeholder="Write a message"></textarea>
              <button type="submit" id="btn-chat" class="send-btn" aria-label="Send message">Send</button>
            </form>
          </div>
        </div>
      </div>

<script>
  // Choose appropriate WS protocol
  const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const socketURL = `${wsScheme}://${window.location.host}/ws/messages/{{room_event}}/`;
  console.log('Connecting to', socketURL);
  const socket = new WebSocket(socketURL);

  const messageForm = document.getElementById('msg-form');
  const messageInput = document.getElementById('message');
  const btnChat = document.getElementById('btn-chat');
  const chatsContainer = document.getElementById('chats-container');

  function scrollToBottom() {
    chatsContainer.scrollTop = chatsContainer.scrollHeight;
  }

  // Ensure initial scroll to bottom
  setTimeout(scrollToBottom, 50);

  // Safe append message (prevents XSS by using textContent)
  function appendMessage(content, senderIsMe, senderName) {
    const wrapper = document.createElement('div');
    wrapper.className = 'msg ' + (senderIsMe ? 'sent' : 'received');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = content;
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = senderIsMe ? 'Me' : senderName;
    wrapper.appendChild(bubble);
    wrapper.appendChild(meta);
    chatsContainer.appendChild(wrapper);
    scrollToBottom();
  }

  // Submit handler
  messageForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;
    // send via websocket
    const payload = JSON.stringify({
      message: text,
      room_event: '{{ room_event }}',
      sender: '{{ username }}'
    });
    if (socket.readyState === WebSocket.OPEN) {
      socket.send(payload);
      // optimistic UI append
      appendMessage(text, true, '{{ username }}');
      messageInput.value = '';
      messageInput.focus();
    } else {
      console.warn('Socket not open');
    }
  });

  // Enter to send (Shift+Enter for newline)
  messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      messageForm.requestSubmit();
    }
  });

  // Receive messages
  socket.addEventListener('message', function(event) {
    try {
      const payload = JSON.parse(event.data);
      const data = payload.message || payload;
      const sender = data.sender;
      const content = data.message;
      // If the message came from me, we've already shown optimistic UI; skip double-append
      if (sender === '{{ username }}') return;
      appendMessage(content, false, sender);
    } catch (err) {
      console.error('Failed to parse socket message', err);
    }
  });

  socket.addEventListener('open', () => console.log('Socket open'));
  socket.addEventListener('close', () => console.log('Socket closed'));
  socket.addEventListener('error', (e) => console.error('Socket error', e));
</script>
{% endblock %}

{% block footer%}
{% endblock %}